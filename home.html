<!DOCTYPE html>
<html lang="en">
<head>
    <title>User Interface Mock-Up</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCIF_zp9VV0GYMv-G83OVHa-NdVKsK5GJE&callback=initialize" async></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h3>User Interface Mock-Up</h3>
    <div class="container">
        <div class="row">
            <div class="col-6">
                <div class="col-12 box SatelliteBox"><strong>Satellite View</strong>
                    <iframe id="satellite" width="105.3%" height="93%" style="border:0; margin-left: -15px;" loading="lazy" allowfullscreen src="https://www.google.com/maps/embed/v1/place?q=place_id:ChIJq0KHTFYEzkwRvbPlVjh1VnI&key=AIzaSyCIF_zp9VV0GYMv-G83OVHa-NdVKsK5GJE&zoom=18&maptype=satellite"></iframe>
                </div>
                <div class="col-12 box AdditionalBox">
                    <strong>Additional Information</strong>
                    <br>
                    <p style="text-decoration: underline; margin-top: 10px;">User Inputted Address:</p> 
                    <p id="userInputted">301 Wellington St, Ottawa, ON K1A 0J1</p>
                    <br>
                    <p style="text-decoration: underline;">Formatted Address:</p>
                    <p id="current" class="currentAddress">301 Wellington St, Ottawa, ON K1A 0J1</p>
                </div>
            </div>

            <div class="col-6">
                <div class="col-12 box StreetBox"><strong>Street View</strong>
                    <div id="street"></div>
                    <div id="pano" style="width:105.2%; height:222px; border:0; margin-left: -15px;"></div>
                </div>
                <div class="col-12 box MapBox"><strong>Map View</strong>
                    <iframe id="map" width="107.2%" height="89%" style="border:0; margin-left: -15px;" loading="lazy" allowfullscreen src="https://www.google.com/maps/embed/v1/place?q=place_id:ChIJq0KHTFYEzkwRvbPlVjh1VnI&key=AIzaSyCIF_zp9VV0GYMv-G83OVHa-NdVKsK5GJE&zoom=18"></iframe>
                </div>
                <div class="col-12 box buttonBox">
                    <p><strong>Viewing Address</strong></p>
                    <p id="position" style="line-height: 0.5; margin-bottom: 25px;">1/1</p>
                    <label class="file-label" for="file">
                        <div class="file-button">Choose File</div>
                    </label>
                    <p class="file-name">No file chosen</p>
                    <input id="file" id = "csvFile" accept=".csv" type="file">
                    <div class="btn-group">
                        <a href="#" class="previous" id="previous" onclick="previous();">Previous &laquo;</a>
                        <a href="#" class="next" id="next" onclick="next();">Next &raquo;</a>
                    </div>                    
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    var numAddresses = 1;
    var position = 1;
    var counter = 1;
    var data, currentAddress, lat, long, placeID, formattedAddress;
    var csvFile = document.getElementsByTagName('input')[0];
    var infoArea = document.getElementById('file-upload-filename');
    var initAddress = "301 Wellington St, Ottawa, ON K1A 0J1";
    var markerPlaced = false;

    function update(e) {
        fileName.textContent = file.files[0].name;
    }
    const file = document.querySelector('#file'),
        fileName = document.querySelector('.file-name');
    file.addEventListener('change', update);

    function initialize(){
        updateStreet(initAddress);
    }
    
    csvFile.onclick = function(){
        this.value = null;
    };
    csvFile.onchange = function(){
        loadFile();
    };

    function loadFile(){
        if (!csvFile.files[0]){
            alert("Please select a file");
        }
        else if (csvFile.files[0].name.split(".").pop() !== "csv"){
            csvFile = null;
            alert("The file must be of type 'csv'");
        }  

        function csvToArray(allText) {
            var allTextLines = allText.split(/\r\n|\n/);
            var headers = allTextLines[0].split(',');
            var lines = [];
            for (var i=1; i<allTextLines.length; i++){
                var data = allTextLines[i].split(',');
                if (data.length == headers.length){
                    for (var j=0; j<headers.length; j++){
                        lines.push(data[j]);
                    }
                }
            }
            return lines.slice(0, -1);
        }
    
        var input = csvFile.files[0];
        var reader = new FileReader();

        reader.onload = function(e){
            var text = e.target.result;
            data = csvToArray(text);
            numAddresses = data.length;
            document.getElementById("position").innerHTML = position + "/" + numAddresses;
            updateMap(returnAddress(position));
        };
        reader.readAsText(input);
    }

    function next(){
        if (!csvFile.files[0]) {
            alert("Please choose a file before clicking 'Next'");
        }
        if (position < numAddresses){
            position++;
            currentAddress = data[position-1];
        }
        document.getElementById("position").innerHTML = position + "/" + numAddresses;
        updateMap(returnAddress(position));
    }

    function previous(){
        if (!csvFile.files[0]) {
            alert("Please choose a file before clicking 'Previous'");
        }
        if (position > 1){
            position--;
            currentAddress = data[position-1];
        }
        document.getElementById("position").innerHTML = position + "/" + numAddresses;
        updateMap(returnAddress(position));
    }

    function addressToCoordinates(location){
        try {
            const promise = axios.get('https://maps.googleapis.com/maps/api/geocode/json',{
                params:{
                    address:location,
                    key:'AIzaSyCIF_zp9VV0GYMv-G83OVHa-NdVKsK5GJE'
                }
            })
            return promise;
        }
        catch (error) {
            console.log(error);
        }
    }

    function updateMap(location){
        addressToCoordinates(location).then((response)=>{
            let lat = response.data.results[0].geometry.location.lat;
            let long = response.data.results[0].geometry.location.lng;
            let placeID = response.data.results[0].place_id;
            let formattedAddress = response.data.results[0].formatted_address;
            document.getElementById("current").innerHTML = formattedAddress;
            document.getElementById("userInputted").innerHTML = returnAddress(position);

            var newSatellite = "https://www.google.com/maps/embed/v1/place?q=place_id:" + placeID + "&key=AIzaSyCIF_zp9VV0GYMv-G83OVHa-NdVKsK5GJE&zoom=21&maptype=satellite";
            document.getElementById("satellite").src = newSatellite;
            var newMap = "https://www.google.com/maps/embed/v1/place?q=place_id:" + placeID + "&key=AIzaSyCIF_zp9VV0GYMv-G83OVHa-NdVKsK5GJE&zoom=19";
            document.getElementById("map").src = newMap; 
            
            updateStreet(formattedAddress).then(
                (markerPlaced) => {
                    console.log("Marker placed");
                },
                (markerPlaced) => {
                    console.log("Could not place marker");
                }
            );
        })
    }

    function returnAddress(position){
        currentAddress = data[position-1];
        return currentAddress;
    }

    function updateStreet(address) {
        var geocoder = new google.maps.Geocoder();
        var myStreetView = null;
        var marker = null;
        markerPlaced = false;

        var sv = new google.maps.StreetViewService();
        var map = new google.maps.Map(document.getElementById("street"));
        myStreetView = new google.maps.StreetViewPanorama(document.getElementById("pano"));
        
        geocoder.geocode({
            "address": address
        },             
        function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                myStreetView.setPosition(results[0].geometry.location);

                sv.getPanorama({
                    location: results[0].geometry.location,
                    source: google.maps.StreetViewSource.OUTDOOR
                }, processSVData);
                
                function processSVData(data, status) {
                    google.maps.event.addListenerOnce(myStreetView, "status_changed", function() {
                        var heading = google.maps.geometry.spherical.computeHeading(myStreetView.getLocation().latLng, results[0].geometry.location);
                        myStreetView.setPano(data.location.pano);
                        myStreetView.setPov({
                            heading: heading,
                            pitch: 0
                        });
                        marker = new google.maps.Marker({
                            position: results[0].geometry.location,
                            map: myStreetView,
                            title: address
                        });
                        if (marker && marker.setMap){
                            marker.setMap(myStreetView);
                        }
                        markerPlaced = true;
                        myStreetView.setVisible(true);
                        map.setStreetView(myStreetView);
                    });
                }
            }
            else {
                console.log("Status: " + status);
            } 
            
        });
    }
</script>

</html>